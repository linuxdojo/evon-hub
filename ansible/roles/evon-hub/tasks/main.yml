---

### Setup base OS

- name: ensure we are running on Amazon Linux
  ansible.builtin.shell: grep "Amazon Linux" /etc/system-release
  changed_when: false

- name: install epel release
  ansible.builtin.shell: |
    rpm -qi epel-release >/dev/null 2>&1
    if [ $? -ne 0 ]; then
      yes | amazon-linux-extras install epel
    fi
  register: shell_output
  changed_when: "'Installing:' in shell_output.stdout"

- name: enable ipv4 forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    reload: yes


### determine version

- name: set verssion fact
  ansible.builtin.set_fact:
    version: "{{ lookup('file', '/opt/evon-hub/version.txt') }}"


### Setup sslh

- name: check if sslh config file is modified
  ansible.builtin.shell: rpm -Vf /etc/sslh.cfg
  register: ssllh_cfg
  changed_when: false
  failed_when: false

- name: update sslh config file
  ansible.builtin.copy:
    src: sslh/sslh.cfg
    dest: /etc/sslh.cfg
  when: ssllh_cfg.rc == 0
  register: sslh_cfg_copy

- name: restart sslh service
  ansible.builtin.service:
    name: sslh
    state: restarted
  when: sslh_cfg_copy.changed


### Setup bins

- name: copy bin files
  ansible.builtin.copy:
    src: bin/
    dest: /usr/local/bin/
    mode: 755

### Setup iptables

- name: configure iptables
  ansible.builtin.template:
    src: iptables/iptables
    dest: /etc/sysconfig/iptables
  register: iptables_copy

- name: ensure iptables service is started and persisted
  ansible.builtin.service:
    name: iptables
    enabled: true
    state: started
  when: not iptables_copy.changed

- name: conditionally restart and persist iptables service
  ansible.builtin.service:
    name: iptables
    state: restarted
    enabled: true
  when: iptables_copy.changed


### Setup Squid

- name: configure squid
  ansible.builtin.service:
    name: squid
    enabled: true
    state: started


### Setup rsyslog and logrotate

- name: configure rsyslog
  ansible.builtin.copy:
    src: rsyslog/evon.conf
    dest: /etc/rsyslog.d/evon.conf
  register: rsyslog_copy

- name: restart rsyslog
  ansible.builtin.service:
    name: rsyslog
    state: restarted
  when: rsyslog_copy.changed

- name: configure logrotate
  ansible.builtin.copy:
    src: logrotate/evon
    dest: /etc/logrotate.d/evon


### Setup Nginx

- name: check if nginx config is present
  ansible.builtin.stat:
    path: /etc/nginx/conf.d/evon.conf
  register: nginx_config_file

- name: configure nginx
  ansible.builtin.template:
    src: nginx/evon.conf
    dest: /etc/nginx/conf.d/evon.conf
  when: not nginx_config_file.stat.exists
  register: configure_nginx

- name: restart nginx
  ansible.builtin.service:
    name: nginx
    state: restarted
    enabled: true
  when: configure_nginx.changed

- name: persist nginx service
  ansible.builtin.service:
    name: nginx
    enabled: true
    state: started
  when: not configure_nginx.changed


### Setup CertBot

- name: check if certbot already configured
  ansible.builtin.lineinfile:
    path: /etc/nginx/conf.d/evon.conf
    regexp: 'managed by Certbot'
    state: absent
  check_mode: yes
  changed_when: false
  register: certbot_config

- name: deploy certbot
  ansible.builtin.shell: certbot run -d {{ account_domain }} --nginx -n --agree-tos --email root@{{ account_domain }}
  when: not certbot_config.found
  register: certbot_deploy

- name: setup certbot auto renewal
  ansible.builtin.copy:
    src: cron.d/certbot
    dest: /etc/cron.d/certbot
  when: certbot_deploy.changed
  
- name: configure nginx bind port
  ansible.builtin.replace:
    path: /etc/nginx/conf.d/evon.conf
    regexp: '443'
    replace: '1443'
  when: certbot_deploy.changed

- name: restart nginx after certbot deploy
  ansible.builtin.service:
    name: nginx
    state: restarted
  when: certbot_deploy.changed


 ### Setup motd

- name: configure motd
  ansible.builtin.template:
    src: motd/motd
    dest: /etc/motd


### setup and configure easy-rsa

- name: configure easy-rsa dir
  ansible.builtin.set_fact:
    easy_rsa_dir: "/etc/openvpn/server/easy-rsa"

- name: deploy certificate authority

  block:

    - name: check if ca already deployed
      ansible.builtin.stat:
        path: "{{ easy_rsa_dir }}"
      register: easyrsa_dir

    - name: deploy ca scripts
      ansible.builtin.shell: "cp -r $(find /usr/share/easy-rsa -maxdepth 1 -mindepth 1 -type d) {{ easy_rsa_dir }}"
      when: not easyrsa_dir.stat.exists

    - name: deploy ca vars
      ansible.builtin.template:
        src: pki/vars
        dest: "{{ easy_rsa_dir }}/vars"

    - name: check if ca is initialised
      ansible.builtin.stat:
        path: "{{ easy_rsa_dir }}/pki"
      register: easyrsa_init

    - name: "initialise ca - this may take a while..."
      ansible.builtin.shell: |
        cd "{{ easy_rsa_dir }}"
        ./easyrsa init-pki
        ./easyrsa gen-dh
        ./easyrsa build-ca nopass <<< {{ ec2_id }}.ca.evon-hub
        ./easyrsa build-server-full {{ ec2_id }}.server.evon-hub nopass
        ./easyrsa build-client-full {{ ec2_id }}.endpoint.evon-hub nopass
        ./easyrsa build-client-full {{ ec2_id }}.user.evon-hub nopass
        openvpn --genkey --secret pki/ta.key
      when: not easyrsa_init.stat.exists

  rescue:

    - name: post-failure cleanup
      ansible.builtin.file:
        state: absent
        path: "{{ easy_rsa_dir }}"

    - name: post-failure exit
      ansible.builtin.fail:
        msg: "exiting due to failure in task: {{ ansible_failed_task.name }}"


### setup OpenVPN

- name: create ccd dir
  ansible.builtin.file:
    path: /etc/openvpn/ccd
    state: directory

- name: deploy openvpn tcp server config
  ansible.builtin.template:
    src: openvpn/server/server_tcp.conf
    dest: /etc/openvpn/server/server_tcp.conf
  register: openvpn_tcp_cfg

- name: deploy openvpn udp server config
  ansible.builtin.template:
    src: openvpn/server/server_udp.conf
    dest: /etc/openvpn/server/server_udp.conf
  register: openvpn_udp_cfg

- name: restart openvpn tcp server
  ansible.builtin.service:
    name: openvpn-server@server_tcp.service
    state: restarted
    enabled: true
  when: openvpn_tcp_cfg.changed

- name: persist openvpn tcp service
  ansible.builtin.service:
    name: openvpn-server@server_tcp.service
    enabled: true
    state: started

- name: restart openvpn udp server
  ansible.builtin.service:
    name: openvpn-server@server_udp.service
    state: restarted
    enabled: true
  when: openvpn_udp_cfg.changed

- name: persist openvpn udp service
  ansible.builtin.service:
    name: openvpn-server@server_udp.service
    enabled: true
    state: started


### setup Bootstrapper

- name: check if bootstrap exists
  ansible.builtin.stat:
    path: /var/www/html/bootstrap.sh
  register: bootstrap_script

- name: setup evon bootstrap
  block:
    - name: create bootstrap build dir
      ansible.builtin.file:
        path: /opt/evon-hub/build_bootstrap
        state: directory

    - name: create webroot dir
      ansible.builtin.file:
        path: /var/www/html
        state: directory
        owner: nginx

    - name: compute bootstrap key
      ansible.builtin.shell: 'curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | jq -jr ".accountId, .instanceId" | md5sum | awk ''{print $1}'''
      register: bootstrap_key_cmd

    - name: set bootstrap facts
      ansible.builtin.set_fact:
        ca_cert: "{{ lookup('file', '{{ easy_rsa_dir }}/pki/ca.crt') }}"
        client_cert: "{{ lookup('file', '{{ easy_rsa_dir }}/pki/issued/{{ ec2_id }}.endpoint.evon-hub.crt') }}"
        client_key: "{{ lookup('file', '{{ easy_rsa_dir }}/pki/private/{{ ec2_id }}.endpoint.evon-hub.key') }}"
        tls_auth_key: "{{ lookup('file', '{{ easy_rsa_dir }}/pki/ta.key') }}"
        bootstrap_key: "{{ bootstrap_key_cmd.stdout }}"

    - name: render bootstrap client config
      ansible.builtin.template:
        src: bootstrap/openvpn_client.conf
        dest: /opt/evon-hub/build_bootstrap/openvpn_client.conf

    - name: render bootstrap proxy config
      ansible.builtin.template:
        src: bootstrap/openvpn_proxy.conf
        dest: /opt/evon-hub/build_bootstrap/openvpn_proxy.conf

    - name: render bootstrap secrets config
      ansible.builtin.template:
        src: bootstrap/openvpn_secrets.conf
        dest: /opt/evon-hub/build_bootstrap/openvpn_secrets.conf

    - name: render bootstrap installer script template
      ansible.builtin.template:
        src: bootstrap/bootstrap_template.sh
        dest: /opt/evon-hub/build_bootstrap/bootstrap.sh

    - name: encrypt bootstrap secrets
      ansible.builtin.shell: "openssl enc -aes-256-cbc -pass pass:{{ bootstrap_key }} -in /opt/evon-hub/build_bootstrap/openvpn_secrets.conf -out /opt/evon-hub/build_bootstrap/openvpn_secrets.conf.aes"

    - name: build bootstrap script
      ansible.builtin.shell: |
        cd /opt/evon-hub/build_bootstrap
        tar -c openvpn_client.conf openvpn_proxy.conf openvpn_secrets.conf.aes | gzip | base64 >> bootstrap.sh
        chmod +x /opt/evon-hub/build_bootstrap/bootstrap.sh
        mv /opt/evon-hub/build_bootstrap/bootstrap.sh /var/www/html

    - name: cleanup
      ansible.builtin.file:
        state: absent
        path: /opt/evon-hub/build_bootstrap
  when: not bootstrap_script.stat.exists

  rescue:
    - name: post-failure cleanup
      ansible.builtin.file:
        state: absent
        path: /opt/evon-hub/build_bootstrap

    - name: post-failure exit
      ansible.builtin.fail:
        msg: "exiting due to failure in task: {{ ansible_failed_task.name }}"

# TODO:
### setup Mapper

