---

# Setup base OS

- name: validate Amazon Linux
  shell: grep "Amazon Linux" /etc/system-release
  changed_when: false

- name: install epel release
  shell: |
    rpm -qi epel-release >/dev/null 2>&1
    if [ $? -ne 0 ]; then
      yes | amazon-linux-extras install epel
    fi
  register: shell_output
  changed_when: "'Installing:' in shell_output.stdout"

- name: install latest required base packages
  ansible.builtin.yum:
    name:
      - certbot
      - easy-rsa
      - htop
      - jq
      - iptables-services
      - nginx
      - openvpn
      - python2-certbot-nginx
      - squid
      - sslh
      - tmux
      - vim
    state: latest

- name: upgrade all packages
  yum: 
    name: '*'
    state: latest

- name: enable ipv4 forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    reload: yes

# Setup sslh

- name: check if sslh config file is modified
  shell: rpm -Vf /etc/sslh.cfg
  register: ssllh_cfg
  changed_when: false
  failed_when: false

- name: update sslh config file
  ansible.builtin.copy:
    src: sslh/sslh.cfg
    dest: /etc/sslh.cfg
  when: ssllh_cfg.rc == 0
  register: sslh_cfg_copy

- name: restart sslh service
  ansible.builtin.service:
    name: sslh
    state: restarted
  when: sslh_cfg_copy.changed

# setup bins

- name: copy bin files
  ansible.builtin.copy:
    src: bin/
    dest: /usr/local/bin/
    mode: 755

# setup iptables

- name: configure iptables
  ansible.builtin.template:
    src: iptables/iptables
    dest: /etc/sysconfig/iptables
  register: iptables_copy

- name: start and persist iptables
  ansible.builtin.service:
    name: iptables
    enabled: true
    state: started
  when: not iptables_copy.changed

- name: restart and persist iptables service
  ansible.builtin.service:
    name: iptables
    state: restarted
    enabled: true
  when: iptables_copy.changed

# setup squid

- name: configure squid
  ansible.builtin.service:
    name: squid
    enabled: true
    state: started

# TODO:
# setup Nginx
# setup CertBot
# setup OpenVPN
# setup Mapper
# setup Bootstrapper

