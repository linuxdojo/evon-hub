---

# Setup base OS

- name: validate Amazon Linux
  shell: grep "Amazon Linux" /etc/system-release
  changed_when: false

- name: install epel release
  shell: |
    rpm -qi epel-release >/dev/null 2>&1
    if [ $? -ne 0 ]; then
      yes | amazon-linux-extras install epel
    fi
  register: shell_output
  changed_when: "'Installing:' in shell_output.stdout"

- name: install latest required base packages
  ansible.builtin.yum:
    name:
      - openvpn
      - easy-rsa
      - sslh
      - nginx
      - squid
      - tmux
      - vim
      - htop
      - certbot
      - python2-certbot-nginx
    state: latest

- name: upgrade all packages
  yum: 
    name: '*'
    state: latest

- name: enable ipv4 forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    reload: yes

